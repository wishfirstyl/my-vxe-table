"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var l=0,t=new Array(e.length);l<e.length;l++)t[l]=e[l];return t}}function _defineProperty(e,l,t){return l in e?Object.defineProperty(e,l,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[l]=t,e}var scrollProcessTimeout,cellType="body";function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function countTreeExpand(e,l){var t=l.$table,r=e[t.treeOpts.children],o=1;if(t.isTreeExpandByRow(e))for(var n=0;n<r.length;n++)o+=countTreeExpand(r[n],l);return o}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,l){var t=e.$table,r=e.$rowIndex,o=1;return r&&(o=countTreeExpand(l[r-1],e)),t.rowHeight*o-(r?1:12-getOffsetSize(t))}function renderLine(e,l,t,r,o,n){var i=n.column,s=t.treeOpts,c=t.treeConfig;return i.slots&&i.slots.line?i.slots.line.call(t,n,e):i.treeNode&&c&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,o),"px"),left:"".concat(r*s.indent+(r?2-getOffsetSize(t):0)+16,"px")}})])]:[]}function renderBorder(e,l){return e("div",{class:"vxe-table-".concat(l,"ed-borders"),ref:"".concat(l,"Borders")},[e("span",{class:"vxe-table-border-top",ref:"".concat(l,"Top")}),e("span",{class:"vxe-table-border-right",ref:"".concat(l,"Right")}),e("span",{class:"vxe-table-border-bottom",ref:"".concat(l,"Bottom")}),e("span",{class:"vxe-table-border-left",ref:"".concat(l,"Left")})])}function renderColumn(e,l,t,r,o,n,i,s,c,a,d,u,p,f,y,v){var x,g,h=t._e,b=t.$listeners,m=t.tableData,w=t.height,_=t.columnKey,T=t.overflowX,S=t.scrollXLoad,$=t.scrollYLoad,O=t.highlightCurrentRow,C=t.showOverflow,L=t.align,k=t.currentColumn,E=t.cellClassName,R=t.cellStyle,I=t.spanMethod,B=t.radioOpts,q=t.checkboxOpts,P=t.expandOpts,U=t.treeOpts,A=t.tooltipOpts,D=t.mouseConfig,H=t.mouseOpts,M=t.editConfig,N=t.editOpts,X=t.editRules,j=t.validOpts,z=t.editStore,W=t.validStore,Y=u.editRender,F=u.align,K=u.showOverflow,G=u.className,V=u.treeNode,J=z.actived,Q=A.enabled,Z=D&&H.selected,ee=D&&(H.range||H.checked),le=i?u.fixed!==i:u.fixed&&T,te=_xeUtils.default.isUndefined(K)||_xeUtils.default.isNull(K)?C:K,re="ellipsis"===te,oe="title"===te,ne=!0===te||"tooltip"===te,ie=oe||ne||re,se={},ce=F||L,ae=W.row===c&&W.column===u,de=X&&("default"===j.message?w||1<m.length:"inline"===j.message),ue={"data-colid":u.id},pe=b["cell-mouseenter"],fe=b["cell-mouseleave"],ye=Y&&M&&"dblclick"===N.trigger,ve={$table:t,$seq:r,seq:o,rowid:n,row:c,rowIndex:a,$rowIndex:d,column:u,columnIndex:p,$columnIndex:f,fixed:i,type:cellType,isHidden:le,level:s,data:m,items:v};if(!S&&!$||ie||(re=ie=!0),(oe||ne||Q||pe)&&(se.mouseenter=function(e){isOperateMouse(t)||(oe?_tools.DomTools.updateCellTitle(e,u):(ne||Q)&&t.triggerTooltipEvent(e,ve),pe&&t.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},ve),e))}),(ne||Q||b["cell-bindMouseleave"])&&(se.mouseleave=function(e){isOperateMouse(t)||((ne||Q)&&t.handleTargetLeaveEvent(e),fe&&t.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},ve),e))}),(q.range||ee||Z)&&(se.mousedown=function(e){t.triggerCellMousedownEvent(e,ve)}),(O||b["cell-click"]||ee||Y&&M||"row"===P.trigger||"cell"===P.trigger||"row"===B.trigger||"radio"===u.type&&"cell"===B.trigger||"row"===q.trigger||("checkbox"===u.type||"selection"===u.type)&&"cell"===q.trigger||"row"===U.trigger||u.treeNode&&"cell"===U.trigger)&&(se.click=function(e){t.triggerCellClickEvent(e,ve)}),(ye||b["cell-dblclick"])&&(se.dblclick=function(e){t.triggerCellDBLClickEvent(e,ve)}),I){var xe=I(ve)||{},ge=xe.rowspan,he=void 0===ge?1:ge,be=xe.colspan,me=void 0===be?1:be;if(!he||!me)return null;1<he&&(ue.rowspan=he),1<me&&(ue.colspan=me)}!le&&Y&&M&&N.showStatus&&(g=t.isUpdateByRow(c,u.property));var we="seq"===u.type||"index"===u.type?"seq":u.type;return e("td",{class:["vxe-body--column",u.id,(_defineProperty(x={},"col--".concat(ce),ce),_defineProperty(x,"col--".concat(we),we),_defineProperty(x,"col--last",f===y.length-1),_defineProperty(x,"col--tree-node",V),_defineProperty(x,"col--edit",!!Y),_defineProperty(x,"col--ellipsis",ie),_defineProperty(x,"fixed--hidden",le),_defineProperty(x,"col--dirty",g),_defineProperty(x,"col--actived",M&&Y&&J.row===c&&(J.column===u||"row"===N.mode)),_defineProperty(x,"col--valid-error",ae),_defineProperty(x,"col--current",k===u),x),_tools.UtilTools.getClass(G,ve),_tools.UtilTools.getClass(E,ve)],key:_?u.id:f,attrs:ue,style:R?_xeUtils.default.isFunction(R)?R(ve):R:null,on:se},C&&le?[e("div",{class:["vxe-cell",{"c--title":oe,"c--tooltip":ne,"c--ellipsis":re}]})]:renderLine(e,l,t,s,v,ve).concat([e("div",{class:["vxe-cell",{"c--title":oe,"c--tooltip":ne,"c--ellipsis":re}],attrs:{title:oe?_tools.UtilTools.getCellLabel(c,u,ve):null}},u.renderCell(e,ve)),de?ae?e("div",{class:"vxe-cell--valid",style:W.rule&&W.rule.maxWidth?{width:"".concat(W.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},W.content)]):h():null]))}function renderRows(u,p,f,y,v,x,g,h){var b=f.stripe,m=f.rowKey,w=f.highlightHoverRow,_=f.rowClassName,T=f.rowStyle,S=f.showOverflow,$=f.treeConfig,O=f.treeOpts,C=f.treeExpandeds,L=f.scrollYLoad,k=f.scrollYStore,E=f.editStore,R=f.rowExpandeds,I=f.radioOpts,B=f.checkboxOpts,q=f.expandColumn,P=f.getColumnIndex,U=[];return g.forEach(function(r,o){var e={},n=o,i=n+1;L&&(i+=k.startIndex),n=f.getRowIndex(r),w&&(e.mouseenter=function(e){isOperateMouse(f)||f.triggerHoverEvent(e,{row:r,rowIndex:n})},e.mouseleave=function(){isOperateMouse(f)||f.clearHoverRow()});var s=_tools.UtilTools.getRowid(f,r);if(U.push(u("tr",{class:["vxe-body--row",{"row--stripe":b&&(f._getRowIndex(r)+1)%2==0,"is--new":-1<E.insertList.indexOf(r),"row--radio":I.highlight&&f.selectRow===r,"row--cheched":B.highlight&&f.isCheckedByCheckboxRow(r)},_?_xeUtils.default.isFunction(_)?_({$table:f,$seq:y,seq:i,rowid:s,fixed:x,type:cellType,rowLevel:v,row:r,rowIndex:n,$rowIndex:o}):_:""],attrs:{"data-rowid":s},style:T?_xeUtils.default.isFunction(T)?T({$table:f,$seq:y,seq:i,rowid:s,fixed:x,type:cellType,rowLevel:v,row:r,rowIndex:n,$rowIndex:o}):T:null,key:m||$?s:o,on:e},h.map(function(e,l){var t=P(e);return renderColumn(u,p,f,y,i,s,x,v,r,n,o,e,t,l,h,g)}))),q&&R.length&&-1<R.indexOf(r)){var l,t=P(q);$&&(l={paddingLeft:"".concat(v*O.indent+30,"px")});var c=q.showOverflow,a=_xeUtils.default.isUndefined(c)||_xeUtils.default.isNull(c)?S:c;U.push(u("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(s),style:T?_xeUtils.default.isFunction(T)?T({$table:f,$seq:y,seq:i,rowid:s,fixed:x,type:cellType,rowLevel:v,row:r,rowIndex:n,$rowIndex:o,isExpanded:!0}):T:null,on:e},[u("td",{class:["vxe-body--expanded-column",{"fixed--hidden":x,"col--ellipsis":a}],attrs:{colspan:h.length}},[u("div",{class:"vxe-body--expanded-cell",style:l},[q.renderData(u,{$table:f,seq:i,rowid:s,row:r,rowIndex:n,column:q,columnIndex:t,fixed:x,type:cellType,level:v})])])]))}if($&&C.length){var d=r[O.children];d&&d.length&&-1<C.indexOf(r)&&U.push.apply(U,_toConsumableArray(renderRows(u,p,f,y?"".concat(y,".").concat(i):"".concat(i),v+1,x,d,h)))}}),U}function syncBodyScroll(e,l,t){(l||t)&&(l&&(l.onscroll=null,l.scrollTop=e),t&&(t.onscroll=null,t.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){l&&(l.onscroll=l._onscroll),t&&(t.onscroll=t._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,l=this.$el,t=this.$refs,r=this.fixedType,o=e.elemStore,n="".concat(r||"main","-body-");o["".concat(n,"wrapper")]=l,o["".concat(n,"table")]=t.table,o["".concat(n,"colgroup")]=t.colgroup,o["".concat(n,"list")]=t.tbody,o["".concat(n,"xSpace")]=t.xSpace,o["".concat(n,"ySpace")]=t.ySpace,o["".concat(n,"checkRange")]=t.checkRange,o["".concat(n,"emptyBlock")]=t.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(t){var e,l=this._e,r=this.$parent,o=this.fixedColumn,n=this.fixedType,i=r.$scopedSlots,s=r.tId,c=r.tableData,a=r.tableColumn,d=r.showOverflow,u=r.spanMethod,p=r.scrollXLoad,f=r.mouseConfig,y=r.mouseOpts,v=r.emptyRender,x=r.emptyOpts,g=r.keyboardConfig,h=void 0===g?{}:g,b=f&&(y.range||y.checked);if(u||(n&&d?a=o:p&&n&&(a=o)),i.empty)e=i.empty.call(this,{$table:this},t);else{var m=v?_vXETable.default.renderer.get(x.name):null;e=m&&m.renderEmpty?m.renderEmpty.call(this,t,x,{$table:this},{$table:this}):_conf.default.i18n("vxe.table.emptyText")}return t("div",{class:["vxe-table--body-wrapper",n?"fixed-".concat(n,"--wrapper"):"body--wrapper"],attrs:{"data-tid":s}},[n?l():t("div",{class:"vxe-body--x-space",ref:"xSpace"}),t("div",{class:"vxe-body--y-space",ref:"ySpace"}),t("table",{class:"vxe-table--body",attrs:{"data-tid":s,cellspacing:0,cellpadding:0,border:0},ref:"table"},[t("colgroup",{ref:"colgroup"},a.map(function(e,l){return t("col",{attrs:{name:e.id},key:l})})),t("tbody",{ref:"tbody"},renderRows(t,this,r,"",0,n,c,a))]),n||!b&&!h.isCut?null:t("div",{class:"vxe-table--borders"},[b?renderBorder(t,"check"):null,h.isCut?renderBorder(t,"copy"):null]),t("div",{ref:"checkRange",class:"vxe-table--checkbox-range"}),n?null:t("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[t("div",{class:"vxe-table--empty-content"},e)])])},methods:{scrollEvent:function(e){var l=this.$parent,t=this.fixedType,r=l.$refs,o=l.highlightHoverRow,n=l.scrollXLoad,i=l.scrollYLoad,s=l.lastScrollTop,c=l.lastScrollLeft,a=r.tableHeader,d=r.tableBody,u=r.leftBody,p=r.rightBody,f=r.tableFooter,y=a?a.$el:null,v=f?f.$el:null,x=d.$el,g=u?u.$el:null,h=p?p.$el:null,b=x.scrollTop,m=x.scrollLeft,w=m!==c,_=b!==s;l.lastScrollTop=b,l.lastScrollLeft=m,l.lastScrollTime=Date.now(),o&&l.clearHoverRow(),g&&"left"===t?syncBodyScroll(b=g.scrollTop,x,h):h&&"right"===t?syncBodyScroll(b=h.scrollTop,x,g):(w&&(y&&(y.scrollLeft=x.scrollLeft),v&&(v.scrollLeft=x.scrollLeft)),(g||h)&&(l.checkScrolling(),_&&syncBodyScroll(b,g,h))),n&&w&&(l.triggerScrollXEvent(e),y&&m+x.clientWidth>=x.scrollWidth-80&&this.$nextTick(function(){x.scrollLeft!==y.scrollLeft&&(y.scrollLeft=x.scrollLeft)})),i&&_&&l.triggerScrollYEvent(e),l.emitEvent("scroll",{type:cellType,fixed:t,scrollTop:b,scrollLeft:m,isX:w,isY:_},e)}}};exports.default=_default;